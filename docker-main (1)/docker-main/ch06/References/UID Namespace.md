## 컨테이너 보안, 사용자 ID의 마법: UID 네임스페이스 🧙‍♂️

컨테이너 기술이 IT 생태계의 주류로 자리 잡으면서, 컨테이너 보안은 더 이상 간과할 수 없는 핵심 과제가 되었습니다. 그중에서도 **UID 네임스페이스**는 컨테이너의 격리성을 강화하고 잠재적인 보안 위협을 효과적으로 차단하는 강력한 방어 메커니즘으로 평가받고 있습니다. 이 글에서는 컨테이너 UID 네임스페이스의 동작 원리부터 실제 적용 사례, 그리고 그 한계점까지 심층적으로 다루어 보겠습니다.

-----

### 1\. UID 네임스페이스의 탄생 배경

컨테이너는 기본적으로 **호스트 커널**을 공유합니다. 이는 호스트와 컨테이너가 동일한 **사용자 및 그룹 ID(UID/GID)** 시스템을 사용한다는 것을 의미합니다. 예를 들어, 컨테이너 내부에서 `root` 사용자로 실행되는 프로세스는 호스트에서도 **UID 0**을 갖게 됩니다. 😱 이 때문에 컨테이너에 취약점이 발생하여 공격자가 `root` 권한을 탈취하게 되면, 이는 곧 호스트 시스템의 `root` 권한 탈취로 이어지는 치명적인 결과를 초래할 수 있습니다.

이러한 문제를 해결하기 위해 **UID 네임스페이스**가 등장했습니다. UID 네임스페이스는 호스트의 UID/GID와 컨테이너 내부의 UID/GID를 분리하여 매핑하는 기술입니다.

-----

### 2\. UID 네임스페이스의 동작 원리: UID 매핑의 마법 ✨

UID 네임스페이스의 핵심은 **UID 매핑(mapping)**에 있습니다. 이는 컨테이너 내부의 특정 UID/GID 범위를 호스트의 다른 UID/GID 범위와 연결하는 과정입니다.

`subuid`와 `subgid` 파일에 매핑 정보를 정의하여, 컨테이너 내부의 사용자 ID가 호스트의 사용자 ID와 다르게 보이도록 만듭니다.

#### **예시: `subuid` 파일**

```bash
# /etc/subuid
root:100000:65536
```

위 설정은 `root` 사용자가 100000부터 65536개의 UID를 하위 UID로 사용할 수 있도록 허용합니다.

#### **매핑 규칙**

| 컨테이너 내부 UID | 호스트 UID |
| :---: | :---: |
| 0 (`root`) | 100000 |
| 1 | 100001 |
| ... | ... |

위 매핑에 따라 컨테이너 내부의 `root` 사용자는 호스트에서는 \*\*`UID 100000`\*\*으로 인식됩니다. 이 비특권 사용자는 호스트 시스템의 중요한 파일(`  /etc/shadow ` 등)에 접근할 수 없으므로, 컨테이너 탈출 공격의 위험이 현저히 줄어듭니다. 즉, 공격자가 컨테이너의 `root` 권한을 탈취해도 호스트 시스템의 **실제 `root` 권한**은 얻을 수 없게 됩니다.

-----

### 3\. 실제 적용: 도커와 쿠버네티스

#### **Docker에서 UID 네임스페이스 적용**

`dockerd` 데몬을 사용자 네임스페이스 모드로 실행하여 모든 컨테이너에 대해 UID 매핑을 활성화할 수 있습니다.

```bash
# /etc/docker/daemon.json
{
  "userns-remap": "default"
}
```

이 설정을 통해 `userns-remap` 옵션을 활성화하면, Docker는 자동으로 `dockremap`이라는 비특권 사용자를 생성하고, 이 사용자의 하위 UID/GID를 컨테이너에 매핑합니다.

#### **Kubernetes에서 UID 네임스페이스 적용**

쿠버네티스는 컨테이너 런타임 인터페이스(CRI)를 통해 UID 네임스페이스를 지원합니다. `Pod` 스펙의 `securityContext`를 통해 컨테이너 내부의 UID를 지정할 수 있지만, UID 네임스페이스를 직접적으로 제어하는 기능은 CRI 구현체(예: `CRI-O`)에 의존합니다. `CRI-O`는 기본적으로 UID 네임스페이스를 활성화하여 **`unprivileged`** 컨테이너를 실행합니다.

-----

### 4\. UID 네임스페이스의 한계와 주의사항 🚧

UID 네임스페이스는 강력한 보안 도구이지만, 몇 가지 한계점과 주의사항이 있습니다.

1.  **호스트 볼륨 마운트**: 호스트의 볼륨을 컨테이너에 마운트할 때 권한 문제가 발생할 수 있습니다. 컨테이너 내부에서 파일 소유자를 `root`로 바꾸어도 호스트에서는 `UID 100000`으로 인식되므로, 마운트된 볼륨의 소유권 변경에 어려움이 있을 수 있습니다.
2.  **퍼포먼스 오버헤드**: UID/GID 매핑은 추가적인 시스템 호출과 권한 검사를 요구하므로, 미미하지만 성능 저하가 발생할 수 있습니다.
3.  **복잡한 설정**: 특히 쿠버네티스 환경에서 UID 네임스페이스를 완벽하게 적용하고 관리하는 것은 복잡한 작업이 될 수 있습니다.

-----

### 5\. 결론: 컨테이너 보안의 필수 도구 🔒

UID 네임스페이스는 단순히 컨테이너를 격리하는 것을 넘어, 컨테이너의 격리성을 **근본적인 수준에서 강화**합니다. 컨테이너 탈출 공격을 차단하는 가장 효과적인 방법 중 하나로, 오늘날의 컨테이너 환경에서는 선택이 아닌 **필수적인 보안 기능**으로 자리 잡고 있습니다.

컨테이너를 운영하는 모든 개발자와 시스템 관리자라면 UID 네임스페이스의 원리를 정확히 이해하고, 이를 적용하여 보다 안전한 컨테이너 환경을 구축해야 할 것입니다.
